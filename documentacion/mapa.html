<script>
    var map = L.map('map', {
        crs: L.CRS.Simple,
        minZoom: -2
    });

    var bounds = [[0,0], [1000,1000]];
    L.imageOverlay('mapa.jpg', bounds).addTo(map);
    map.fitBounds(bounds);

    // Usamos un LayerGroup para manejar marcadores y que sea fácil borrarlos
    var capaMarcadores = L.layerGroup().addTo(map);
    var capaLineas = L.layerGroup().addTo(map);

    var puntos = JSON.parse(localStorage.getItem("ruta")) || [];

    function redibujar() {
        // 1. Limpiar todas las capas visuales
        capaMarcadores.clearLayers();
        capaLineas.clearLayers();

        // 2. Dibujar marcadores
        puntos.forEach((p, index) => {
            var marker = L.marker(p);
            
            // Evento de borrado mejorado
            marker.on('click', function(e) {
                L.DomEvent.stopPropagation(e); // Evita que el click pase al mapa y cree otro punto
                puntos.splice(index, 1);
                guardarYRenderizar();
            });
            
            marker.addTo(capaMarcadores);
        });

        // 3. Dibujar línea
        if (puntos.length > 1) {
            L.polyline(puntos, {color: 'red', weight: 3}).addTo(capaLineas);
        }
    }

    function guardarYRenderizar() {
        localStorage.setItem("ruta", JSON.stringify(puntos));
        redibujar();
    }

    map.on('click', function(e) {
        puntos.push([e.latlng.lat, e.latlng.lng]);
        guardarYRenderizar();
    });

    // Inicio
    redibujar();
</script>