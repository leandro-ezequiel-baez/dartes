<script>

var map = L.map('map', {
    crs: L.CRS.Simple
});

var bounds = [[0,0], [1000,1000]];
var image = L.imageOverlay('mapa.jpg', bounds).addTo(map);
map.fitBounds(bounds);

var puntos = JSON.parse(localStorage.getItem("ruta")) || [];
var markers = [];
var polyline;

// Función para redibujar todo
function redibujar() {

    // borrar línea anterior
    if (polyline) {
        map.removeLayer(polyline);
    }

    // borrar marcadores anteriores
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    // crear nuevos marcadores
    puntos.forEach((p, index) => {
        var marker = L.marker(p).addTo(map);

        // click para borrar
        marker.on('click', function() {
            puntos.splice(index, 1);
            localStorage.setItem("ruta", JSON.stringify(puntos));
            redibujar();
        });

        markers.push(marker);
    });

    // dibujar línea nueva
    if (puntos.length > 1) {
        polyline = L.polyline(puntos).addTo(map);
    }
}

// agregar punto nuevo
map.on('click', function(e) {
    puntos.push([e.latlng.lat, e.latlng.lng]);
    localStorage.setItem("ruta", JSON.stringify(puntos));
    redibujar();
});

// dibujar al iniciar
redibujar();

</script>